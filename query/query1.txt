WITH candidate_tracks AS (
    SELECT
        r.game_id,
        sg.name AS game_name,
        sp.track_id,
        sp.name AS track_name,
        sp.duration_s AS track_duration_s,
        sp.tempo,
        sp.energy,
        sp.valence,
        r.match_score,
        (0.5 * r.match_score + 0.25 * sp.energy + 0.25 * sp.valence) AS fit_score
    FROM "Recommendations" AS r
             JOIN "Steam" sg ON r.game_id = sg.game_id
             JOIN "Spotify" sp ON r.track_id = sp.track_id
    WHERE r.game_id =: game_id
      AND sp.energy BETWEEN :min_energy AND :max_energy
      AND sp.valence BETWEEN :min_valence AND :max_valence
),
     ranked_tracks AS (
         SELECT
             *,
             SUM(track_duration_s) OVER (
                 ORDER BY fit_score DESC
                 ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
                 ) AS cum_duration_s
         FROM candidate_tracks
     ),
     cutoff AS (
         SELECT min(cum_duration_s) AS cutoff_s
         FROM ranked_tracks
         WHERE cum_duration_s >= (:session_minutes * 60)
     )
SELECT
    r.track_id,
    r.tempo,
    r.energy,
    r.valence,
    round(r.fit_score) AS fits_score,
    max(round(c.cutoff_s / 60)) AS playlist_duration
FROM ranked_tracks r
         CROSS JOIN cutoff c
WHERE r.cum_duration_s <= c.cutoff_s
group by r.valence, r.track_id, r.tempo, r.energy, r.fit_score
ORDER BY r.fit_score DESC;

WITH steam_to_spotify_genres AS (
    -- Map each Steam genre to its possible Spotify genres via GenMap
    SELECT DISTINCT
        gg.genre        AS game_genre,    -- Steam genre
        gm.track_genre  AS spotify_genre  -- mapped Spotify genre
    FROM "GameGen" gg JOIN "GenMap" gm ON LOWER(gg.genre) = LOWER(gm.game_genre)
),genre_pair_tracks AS (
    SELECT
        ssg.game_genre,
        ssg.spotify_genre,
        r.track_id
    FROM steam_to_spotify_genres ssg
             JOIN "GameGen" gg2 ON gg2.genre = ssg.game_genre
             JOIN "Recommendations" r ON r.game_id = gg2.game_id
             JOIN "MusicGen" mg ON mg.track_id = r.track_id
        AND LOWER(mg.genre) = LOWER(ssg.spotify_genre)
), agg_pairs AS (
    SELECT
        game_genre,
        spotify_genre,
        COUNT(DISTINCT track_id) AS num_tracks
    FROM genre_pair_tracks
    GROUP BY game_genre, spotify_genre
),
     ranked_pairs AS (
         -- Rank Spotify genres within each Steam genre by number of tracks
         SELECT
             game_genre,
             spotify_genre,
             num_tracks,
             ROW_NUMBER() OVER (
                 PARTITION BY game_genre
                 ORDER BY num_tracks DESC
                 ) AS genre_rank
         FROM agg_pairs
     )
SELECT
    game_genre,        -- Steam genre
    spotify_genre,     -- top Spotify genre for that Steam genre
    num_tracks
FROM ranked_pairs
WHERE genre_rank <= 3